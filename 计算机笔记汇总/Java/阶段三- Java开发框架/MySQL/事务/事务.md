MySQL中的事务是一个由一系列SQL语句组成的单元。这些语句**要么全部执行成功，要么全部不执行**。事务的主要目的是确保数据的完整性和一致性，即使在发生错误或系统崩溃的情况下。

事物**只能使用在DML语句中 (insert, delete, update)**

一个事务其实就是多条DML语句同时成功，或者同时失败。

事务是怎么做到多条DML语句同时成功和同事失败的呢？

- InnoDB存储引擎: 提供一组用来记录事务性活动的日志文件
- 在事务的执行过程中，每一条DML的操作都会记录到“事务性活动的日志文件中。

# 概念

事务**只能使用在DML语句中 (insert, delete, update)**一个事务其实就是多条DML语句同时成功，或者同时失败。

事务是怎么做到多条DML语句同时成功和同时失败的呢？

- InnoDB存储引擎: 提供一组用来记录事务性活动的日志文件
- 在事务的执行过程中，每一条DML的操作都会记录到“事务性活动的日志文件中。

场景：学工部整个部门解散了，该部门及部门下的员工都需要删除了。

```SQL
-- 删除学工部
delete from dept where id = 1;  -- 删除成功

-- 删除学工部的员工
delete from emp where dept_id = 1; -- 删除失败（操作过程中出现错误：造成删除没有成功）
```

问题：如果删除部门成功了，而删除该部门的员工时失败了，此时就造成了数据的不一致。 要解决上述的问题，就需要通过数据库中的事务来解决。

在实际的业务开发中，**有些业务操作要多次访问数据库。一个业务要发送多条SQL语句给数据库执行**。需要将多次**访问数据库的操作视为一个整体来执行**，要么所有的SQL语句全部执行成功。如果其中有一条SQL语句失败，就进行事务的回滚，所有的SQL语句全部执行失败。

简而言之：事务是一组操作的集合，它是一个不可分割的工作单位。事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。

# 操作

MYSQL中有两种方式进行事务的操作：

1. 自动提交事务：即执行一条sql语句提交一次事务。（默认MySQL的事务是自动提交）
2. 手动提交事务：先开启，再提交

事务操作有关的SQL语句：

|   |   |
|---|---|
|SQL语句|描述|
|start transaction;  /  begin ;|开启手动控制事务|
|commit;|提交事务|
|rollback;|回滚事务|

手动提交事务使用步骤：

- 第1种情况：开启事务 => 执行SQL语句 => 成功 => 提交事务
- 第2种情况：开启事务 => 执行SQL语句 => 失败 => 回滚事务

使用事务控制删除部门和删除该部门下的员工的操作：

```SQL
-- 开启事务
start transaction;

-- 删除学工部
delete from tb_dept where id = 1;

-- 删除学工部的员工
delete from tb_emp where dept_id = 1;
```

- 上述的这组SQL语句，如果如果执行成功，则提交事务

```SQL
-- 提交事务 (成功时执行)
commit ;
```

- 上述的这组SQL语句，如果如果执行失败，则回滚事务

```SQL
-- 回滚事务 (出错时执行)
rollback ;
```

# 四大特性

面试题：事务有哪些特性？

- **原子性（Atomicity）**：事务是不可分割的最小单元，要么全部成功，要么全部失败。
- **一致性（Consistency）**：事务完成时，必须使所有的数据都保持一致状态。
- 如果事务成功的完成，那么数据库的所有变化将生效。
- 如果事务执行出现错误，那么数据库的所有变化将会被回滚(撤销)，返回到原始状态。
- **隔离性（Isolation）**：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。多个用户并发的访问数据库时，一个用户的事务不能被其他用户的事务干扰，多个并发的事务之间要相互隔离。
- 一个事务的成功或者失败对于其他的事务是没有影响。
- **持久性（Durability）**：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。一个事务一旦被提交或回滚，它对数据库的改变将是永久性的，哪怕数据库发生异常，重启之后数据亦然存在。

# 提交事务

MySQL默认情况下是支持自动提交事务的。

什么是自动提交？如果不开启事务，那么每执行一条DML语句，就提交一次。这种自动提交实际上不符合我们的开发习惯，因为一个业务通常是需要多条DML语句共同执行才能完成的，为了保证数据安全，必须要求同时成功之后再提交。

# 回滚事务

# 事务的四个特性

1. **原子性 (Atomicity)**：事务中的所有操作要么全部完成，要么全部不完成。不可能只执行事务中的一部分操作。这就是所说的“事务是不可分割的”。
2. **一致性 (Consistency)**：事务必须确保数据库从一个一致的状态转换到另一个一致的状态。在事务开始之前和结束之后，数据库的完整性约束必须保持不变。
3. **隔离性 (Isolation)**：在并发环境中，一个事务的执行不应该被其他事务干扰。即使多个事务并发执行，每个事务都应该感觉好像它是唯一在系统中执行的。
4. **持久性 (Durability)**：一旦事务被提交，它对数据库的更改就是永久性的。即使系统崩溃，更改也不会丢失。

  

  

  

[[事务的隔离级别]]