# 用户签到

## 用户签到-BitMap 功能演示

我们针对签到功能完全可以通过 mysql 来完成，比如说以下这张表: 

![[Pasted image 20240512141920.png]]

用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条。

每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节。

我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了。我们可以采用类似这样的方案来实现我们的签到需求。

我们按月来统计用户签到信息，**签到记录为1，未签到则记录为0**。把**每一个bit位对应当月的每一天**，形成了映射关系。**用0和1标示业务状态，这种思路就称为位图（BitMap）**。这样我们就用极小的空间，来实现了大量数据的表示。

Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。

![[Pasted image 20240512141959.png]]

BitMap的操作命令有：

- SETBIT：向指定位置（offset）存入一个0或1
    
- GETBIT ：获取指定位置（offset）的bit值
    
- BITCOUNT ：统计BitMap中值为1的bit位的数量
    
- BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值
    
- BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回
    
- BITOP ：将多个BitMap的结果做位运算（与 、或、异或）
    
- BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置

## 实现签到功能

需求：实现签到接口，将当前用户当天签到信息保存到Redis中

思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。

我们通过接口文档发现，此接口并没有传递任何的参数，没有参数怎么确实是哪一天签到呢？这个很容易，可以通过后台代码直接获取即可，然后到对应的地址上去修改bitMap。

![[Pasted image 20240512204710.png]]

**代码**

UserController

```java
@PostMapping("/sign")  
public Result sign(){  
  return userService.sign();  
}
```

UserServiceImpl

```java
@Override  
public Result sign() {  
    // 1.获取当前登录用户  
    Long userId = UserHolder.getUser().getId();  
    // 2.获取日期  
    LocalDateTime now = LocalDateTime.now();  
    // 3.拼接key  
    String keySuffix = now.format(DateTimeFormatter.ofPattern(":yyyyMM"));  
    String key = USER_SIGN_KEY + userId + keySuffix;  
    // 4.获取今天是本月的第几天  
    int dayOfMonth = now.getDayOfMonth();  
    // 5.写入Redis SETBIT key offset 1  
    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true);  
    return Result.ok();  
}```

