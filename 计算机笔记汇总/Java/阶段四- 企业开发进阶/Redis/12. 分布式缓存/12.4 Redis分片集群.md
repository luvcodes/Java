# 4. Redis分片集群
## 4.1. 搭建分片集群

主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决：

- 海量数据存储问题
  
- 高并发写的问题

使用分片集群可以解决上述问题，如图: 

![[Pasted image 20240515124638.png|475]]

分片集群特征：

- 集群中有多个master，每个master保存不同数据
  
- 每个master都可以有多个slave节点
  
- master之间通过ping监测彼此健康状态
  
- 客户端请求可以访问集群任意节点，最终都会被转发到正确节点

具体搭建流程参考课前资料《Redis集群.md》：

![[Pasted image 20240515124725.png|94]]

## 4.2. 散列插槽
### 4.2.1. 插槽原理
Redis会把每一个master节点映射到0~16383共16384个插槽（hash slot）上，查看集群信息时就能看到：

数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值，分两种情况：

- key中包含"{}"，且“{}”中至少包含1个字符，“{}”中的部分是有效部分
  
- key中不包含“{}”，整个key都是有效部分

例如：key是num，那么就根据num计算，如果是{itcast}num，则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余，得到的结果就是slot值。

### 4.2.1. 小结
Redis如何判断某个key应该在哪个实例？

- 将16384个插槽分配到不同的实例
  
- 根据key的有效部分计算哈希值，对16384取余
  
- 余数作为插槽，寻找插槽所在实例即可

如何将同一类数据固定的保存在同一个Redis实例？

- 这一类数据使用相同的有效部分，例如key都以{typeId}为前缀

