通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。

1、我们将服务启动两份，端口分别为8081和8082：

![[Pasted image 20240506190758.png|400]]

2、然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：

![[Pasted image 20240506190826.png|500]]

**有关锁失效原因分析**

由于现在我们部署了多个tomcat，每个tomcat都有一个属于自己的jvm，那么假设在服务器A的tomcat内部，有两个线程，这两个线程由于使用的是同一份代码，那么他们的锁对象是同一个，是可以实现互斥的。

但是如果现在是服务器B的tomcat内部，又有两个线程，但是他们的锁对象写的虽然和服务器A一样，但是锁对象却不是同一个，所以线程3和线程4可以实现互斥，但是却无法和线程1和线程2实现互斥。

这就是集群环境下，syn锁失效的原因，在这种情况下，我们就需要使用分布式锁[[分布式锁]]来解决这个问题。

![[Pasted image 20240506190906.png]]

