# 概念

Nacos是SpringCloudAlibaba的组件，而SpringCloudAlibaba也遵循SpringCloud中定义的服务注册、服务发现规范。因此**使用Nacos和使用Eureka对于微服务来说，并没有太大区别**。

Nacos是一种服务发现工具，也就是一种注册中心了？nacos可以替代eureka，来和ribbon进行合作吗？

1. **Nacos 作为服务发现工具和注册中心**：Nacos 提供了服务发现和服务注册的功能，这使得它可以作为一个注册中心。在微服务架构中，服务实例会在启动时将自己的信息（如 IP 地址和端口号）注册到 Nacos 中。其他服务或者服务消费者可以通过 Nacos 查询并发现这些服务实例的信息。这种机制允许微服务架构中的服务实例动态地注册和发现，从而提高了整体架构的灵活性和可扩展性。

2. **Nacos 替代 Eureka**：Nacos 不仅提供了与 Eureka 类似的服务注册和发现功能，还提供了配置管理等其他功能。因此，**Nacos 完全可以作为 Eureka 的替代品来使用**。

3. **Nacos 与 Ribbon 的结合**：**Nacos 可以与 Ribbon 结合使用**，**实现客户端负载均衡**。在这种配置中，Ribbon 会从 Nacos 获取服务实例的信息，然后根据配置的负载均衡策略（如轮询、随机等）在这些实例中选择一个进行调用。这样的结合使得服务调用更加高效和均衡。

# 服务分级存储模型

一个**服务**可以有多个**实例**，例如我们的user-service，可以有:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

假如这些实例分布于全国各地的不同机房，例如：

- 127.0.0.1:8081，在上海机房
- 127.0.0.1:8082，在上海机房
- 127.0.0.1:8083，在杭州机房

**Nacos就将同一机房内的实例**划分为一个**集群**。也就是说，user-service是服务，一个服务可以包含多个集群，如杭州、上海，每个集群下可以有多个实例，形成分级模型，如图：

![[nacos01.png]]

## 同集群优先的负载均衡

默认的`ZoneAvoidanceRule`并不能实现根据同集群优先来实现负载均衡。因此Nacos中提供了一个`NacosRule`的实现，可以**优先从同集群中挑选实例**。

```yaml
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # 负载均衡规则 
```

## **Nacos负载均衡策略**

- **优先选择同集群**`ZoneAvoidanceRule`服务实例列表

- 本地集群找不到提供者，才去其他集群寻找，并且报警告 (可以通过停止user-service 1和2，然后开启user-service3，再去网页中访问order-service，看user-service 3接收到了信息，并且order-service的日志中可以看到访问了跨集群寻找)

- **确定了可用实例列表后**，再采用**随机负载均衡**挑选实例

# 权重配置

实际部署中会出现这样的场景：服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。但**默认情况下NacosRule是从集群内随机挑选**，不会考虑机器的性能问题。

因此，Nacos提供了权重配置来控制访问频率，**权重越大则访问频率越高**。

这样做的好处就是如果需要对某个实例进行停机或者更新，就可以把权值调到0，这样不会影响用户的使用，然后再慢慢把权值调大，这样数据的涌入不会是超大量的，而是可以控制的。

# 环境隔离

Nacos中服务存储和数据存储的最外层是namespace，用来做最外层隔离。

Nacos提供了namespace来实现环境隔离功能。

- nacos中可以有多个namespace
- namespace下可以有group、service等
- 不同namespace之间相互隔离，例如**不同namespace的服务互相不可见**

![[nacos02.png]]

要想让服务可以访问，必须要放到相同的环境下。

# Nacos和Eureka的区别

在 Nacos 注册中心中，实例分为临时实例（Ephemeral Instance）和持久化实例（Persistent Instance），它们的主要区别在于服务实例的存活状态与注册信息的存储方式：

## 临时实例与非临时实例

### **临时实例**

临时实例通常是**由客户端在运行时动态注册到 Nacos**的，并且**客户端需要发送心跳来维持其注册状态**。

如果 Nacos 一段时间内没有收到某个临时实例的心跳，它会认为该实例已经不可用，随后将其从服务列表中移除。

这种机制非常适合于轻量级和短暂的服务实例，例如那些可能会频繁启动和停止的服务。

配置一个服务实例为永久实例：

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false # 设置为非临时实例
```

### **持久化实例**

- 持久化实例一旦注册到 Nacos，即使没有心跳维持，它们的**注册信息**也会被**永久保留在Nacos**中。
- 持久化实例适用于那些稳定运行、不会频繁变动的服务实例。
- 即使 Nacos 服务重启，持久化实例的信息也不会丢失，因为它们存储在了持久化存储中（如磁盘、数据库等）。

在微服务架构中，这两种实例类型的选择取决于服务实例的特性和需求。**临时实例**的自动注销特性可以减轻服务发现的维护工作，而**持久化实例**则提供了更稳定的服务注册状态。选择哪种类型，通常需要根据服务的具体情况和架构设计来决定。

## Nacos与Eureka的共同点

- 都支持服务注册和服务拉取 (pull)
- 都支持服务提供者心跳方式做健康检测

## Nacos与Eureka的区别

- Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式
- **临时实例心跳不正常会被剔除，非临时实例则不会被剔除**
- Nacos支持服务列表变更的消息推送 (push)模式，服务列表更新更及时。既有push也有pull。
- Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式

# Nacos配置管理

## 统一配置管理

当微服务部署的实例越来越多，达到数十、数百时，逐个修改微服务配置就会让人抓狂，而且很容易出错。我们需要一种**统一配置管理方案，可以集中管理所有实例的配置**。

![[nacos03.png]]

Nacos一方面可以将**配置集中管理**，另一方可以在**配置变更时，及时通知微服务，实现配置的热更新**。
需要**热更新的配置才有放到nacos管理的必要**，不需要把所有的配置都放进来。
- 注意：项目的核心配置，需要**热更新的配置才有放到nacos管理的必要**。基本不会变更的一些配置还是保存在微服务本地比较好。

[[Nacos配置管理]]

